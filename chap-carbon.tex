\chapter{Carbon: Cloud Workspaces}
\label{chap:carbon}

\section{Purpose}
The purpose of this chapter is to introduce Carbon, a web application for allows users to create personal online modeling and simulation environments.
Carbon may be used by modelers to produce and collaborate new models online, or easily reproduce results from a publication.
While Carbon is still under rapid development, many core features are already in place, which will be discussed here.

\section{Motivation}

For science to advance, experimental reproducibility is crucial. \autocite{peng2011reproducible}
For computational experiments, in theory, a script or program could describe every step taken by the computer, which provides even greater detail than the analogous non-computational experimental descriptions published in journals.
However, the reality is that sometimes the code is not available, either unpublished or nonexistent when the interactive software system does not track the usersâ€™ actions.
Even if the researcher shares code, it may require specific versions of software platforms and packages, which may be difficult to acquire.

While this problem likely will require a combined effort of different measures, one approach is to move researchers towards software platforms and practices that encourage transparency and reproducibility.

\section{Solution}

Carbon aims to lower the barrier to obtaining bio-modeling software by providing personal computing environments available through the browser.
Each researcher can register and log in to access a suite of scientific apps (Figure~\ref{Figure:carbon-login}).
Currently, the two apps that are included are a model visualization and file management tool called Workspaces (developed by this author with Graphene), and IPython Notebook \autocite{perez2007ipython}.

In Workspaces (Figure~\ref{Figure:carbon-workspaces}), the user can perform a variety of file system manage actions, such as creating new folders and files, either through upload or copy-and-paste.
All files within the workspace may be viewed and manipulated through a text editor (Figure~\ref{Figures:carbon-workspaces-files}).
Model file formats, such as SBML, will also be accompanied with a layout view (Figure~\ref{Figure:carbon-workspaces-model-view}).

\subsection{Collaboration}
The knowledge required for a project is often distributed among many individuals, including software developers and subject matter experts. \autocite{ragan2013collaborative}
Although computation can be a language that bridges many disciplines, additional "glue" is often needed to make the requirements mutually comprehensible to diverse members of a project team.

Carbon works as this "glue" through online collaboration, allowing users to work rapidly in a collaborative environment for execution of code within a same programming document, an IPython Notebook, as well as managing any additional viewing files within the workspace.
Workspaces is also provides integration with IPython Notebooks.
A model file may be easily converted into a notebook file (Figure~\ref{Figure:carbon-workspace-convert-to-ipython}).
By default, the new notebook filename is based off the original model file.

The newly created notebook is detected immediately by IPython Notebook (Figure~\ref{Figure:carbon-workspace-ipython-view}), as IPython Notebook and Workspaces share the same working directory.
Within the notebook, helper scripts and functions have already been generated that can be immediately executed to the load and run a simulation of the source model (Figure~\ref{Figure:carbon-ipython-template}).
In addition, a pre-build interactive simulation widget is built for the loaded model (Figure~\ref{Figure:carbon-ipython-widget}).
Sliders are created for each kinetic parameter within the model, and upon sliding, the simulation graph is updated with the new values.
Input boxes are also available for changing start and end simulation times and the number of steps.

A number of python libraries are already installed inside the workspace, including Tellurium, PySCeS, and Pandas.
Users may also install any additional libraries that they may need, either through the terminal or using a package manager such as \texttt{pip}, without affecting the environment of other users.



\subsection{Reproducibility}

Often times, a reader of a journal may wish to run the same simulations specified in the experimental results.
This may be a rather difficult process of finding the right software, model files, and simulation experiment setup.
Carbon makes tries to make this process much simpler.
A desktop client has been developed which allows users to generate URL links directly from Combine Archives \autocite{combine2014archive}
Combine Archives are an emerging standardized zip file, meant to contain all the necessary files to required to reproduce a computational experiment (see section~\ref{sec:combine-archive} for more detail about Combine Archives).
These URLs direct to a Portal landing page that allows the user to open the entire model project on Carbon or locally if they have the necessary software installed (Figure~\ref{Figure:carbon-combine-archive}).

If a SEDML file is detected within the archive, an IPython Notebook will be automatically generated as well, which contains a script for the exact simulation experimental setup.
These URLs may be embedded in virtually any document format, HTML, Microsoft Word, PDF and may also be easily shared via email or messaging clients.

\section{Implementation}

Carbon uses two top level processes a node.js server and a MongoDB database (Docker is also used extensively, which will be discussed in section~\ref{sec:docker}).
Node.js was selected as the platform because of its high performance and ability to use JavaScript on the server \autocite{tilkov2010node}, which eases development by keeping the same programming language between server and client.
Carbon also uses the node.js package management system, \texttt{npm}, extensively to management software dependencies and to easily deploy on multiple platforms. \autocite{lerner2011forge}
The database is primarily used to store user information.
MongoDB was selected as the database of choice simply because the supporting libraries for integrating node.js are well documented and with an active community.
Figure~\ref{fig:carbon-architecture} provides an overview of the implementation and application flow.

New users register by submitting their name, email, and password.
When the server receives this request, a new entry in the Users Collection of the database is added.
In order to protect against malicious attacks to obtain user information, the password is stored as an encrypted hash with salt. \autocite{bellovin1993augmented}
To help automatically provide a profile picture for the user, their email will be checked against gravatar, a service for universal profile pictures based on email.

\subsection{Individual workspace isolation}
\label{sec:docker}

Central to how Carbon works is that each user is assigned a Docker Container.
A Docker Container is an operating system level virtualization method, somewhat like a very lightweight virtual machine, such that the file system and processes within it are isolated from different containers.
The container is created from an image, defined by a text file called the \texttt{Dockerfile}, which can come pre-installed with various programs.
The Docker image used by Carbon contains a number of scientific python libraries, the IPython Notebook server, and Workspaces app.
This level of environmental isolation prevents the processes of users from interfering with one another.
Web applications must run on TCP ports, which internal to each docker is the exact same.
Port collisions are avoided by forwarding all container ports to a unique host port in a predefined port range.
For example, IPython Notebook runs on port 8888, during the container creation, a subroutine checks if port 14597 is free, if it is, it will be assigned and saved as the IPython port for that client.
Each client then has a set of unique port numbers associated with each of the applications that are available.
In the client browser, when one of the app icons is clicked, an \texttt{<iframe>} element is created that connects the main page (which will typically be running on port 80) to the desired application on a different port number.

This architecture makes Carbon quite inclusive with the ability to plug in additional apps, any software application that can be installed on Linux and able to use the web browser as the user interface may be easily added into Carbon.

\subsection{Conversion of models to IPython notebooks}

Automatically generating IPython notebooks is done through a templating process.
Since IPython notebook files are in JSON format, which may be read directly in JavaScript, a default IPython notebook is maintined that contains all the default scripts.
When a notebook is being generated from a model, the model file name is then inserted into the appropriate places in the template.

\subsection{Opening Combine Archives with Carbon}
The Portal works by handling a special set of URLs, for example: 

\begin{lstlisting}[language=html]
http://carbon.sysb.io/redirect?title=test\&format=base64\&archive=aGVsbG8gd29ybGQ=
\end{lstlisting}

First, the URL path is \texttt{redirect}. The \texttt{redirect} route on the server is designed to specially handle this link format.
The client is presented with the option to open the archive with Carbon, or if they have the necessary local
Query parameters \texttt{title}, \texttt{format}, and \texttt{archive} wholly describe the incoming archive file, which in this example is encoded in base64 (this example string just decodes to "hello world!").
Hexadecimal encoding is also supported.
The archive string is decoded by the server and processed by \autocite{sysbio2014sedml2py} to generate python files, which are then converted into IPython Notebook format.
After this is complete, the server redirects the client to the newly created notebook or workspace.
It is important to note that the server can also be installed as a desktop client, which would enable this whole system to work without a external server running.

\section{Future Directions}

Carbon is the culminating part of this work after building underlying tools and gaining experience through the applications described in Chapters \ref{chap:tidal} and \ref{chap:redox}, but much work has yet to be done towards the end goal outlined in Figure~\ref{Figure:carbon-overview}.

The first task will be to add additional social elements, namely, the ability follow other users, and watch, fork, and star projects.
This would require some additional designs in the user database backend in order to track these relationships, as well as additional user interface work to display activity feeds and present visible cues for these types of actions.
In order to support forking and pulling mechanism, where users can make a copy of another's project and then request that features be integrated upstream, a git version control back end will be created allow this functionality.
With this core functionality available, the final step will be to finalize a developer friendly API for Carbon to be easily extended with full ecosystem of plug-and-play style applications.

\begin{figure}
  \centering
  \includegraphics[width=\textwidth, page=28, trim=0cm 0cm 12cm 0cm, clip=true]{images/Figures.pdf}
  \caption{Architecture of Carbon.}
  \label{fig:carbon-architecture}
\end{figure}


\begin{figure}
  \centering
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth, page=9, trim=0.37cm 3.65cm 13.1cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{The Carbon landing page.}
    \label{Figure:carbon-login-landing}
  \end{subfigure}
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth, page=9, trim=13.1cm 3.65cm 0.37cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{Once the user is logged in, the navigation bar will populate with available applications.}
    \label{Figure:carbon-login-logged-in}
  \end{subfigure}
  \caption{Carbon provides a user-specific workspaces.}
  \label{Figure:carbon-login}
\end{figure}

\begin{figure}
  \centering
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=10,trim=0.37cm 3.65cm 13.1cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{The left sidebar contains a collapsible directory tree view.
      Each directory also contains expandable option buttons for file creation, upload, and deletion.}
    \label{Figure:carbon-workspaces-view}
  \end{subfigure}
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=10,trim=13.1cm 3.65cm 0.37cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{New folders can also be created anywhere within the directory tree.}
    \label{Figure:carbon-workspaces-new-folder}
  \end{subfigure}
  \caption{Workspace app is a plugin to Carbon that allows easy file management and browsing of model files.}
  \label{Figure:carbon-workspaces}
\end{figure}

\begin{figure}
  \centering
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=11,trim=0.37cm 3.65cm 13.1cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{Users may create new files in the workspace by upload or copy and paste.}
    \label{Figure:carbon-workspaces-file-upload}
  \end{subfigure}
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=11,trim=13.1cm 3.65cm 0.37cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{All files may be edited as text, but detected model files also uses Graphene to construct a network layout view.}
    \label{Figure:carbon-workspaces-model-view}
  \end{subfigure}
  \caption{Workspace file management.}
  \label{Figure:carbon-workspaces-files}
\end{figure}

\begin{figure}
  \centering
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=12,trim=0.37cm 3.65cm 13.1cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{Model files may be converted into IPython Notebook format.}
    \label{Figure:carbon-workspace-convert-to-ipython}
  \end{subfigure}
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=12,trim=13.1cm 3.65cm 0.37cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{The IPython Notebook view can be reached from the top navigation bar and shows generated notebooks.}
    \label{Figure:carbon-workspace-ipython-view}
  \end{subfigure}
  \caption{Workspace integration with IPython Notebook.}
  \label{Figure:carbon-workspace-ipython-integration}
\end{figure}

\begin{figure}
  \centering
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=13,trim=0.37cm 3.65cm 13.1cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{Notebooks are generated from a template that already contains useful commands for loading useful libraries and helper functions.}
    \label{Figure:carbon-ipython-template}
  \end{subfigure}
  \begin{subfigure}[b]{\textwidth}
    \includegraphics[width=\textwidth,page=13,trim=13.1cm 3.65cm 0.37cm 3.3cm, clip=true]{images/Figures.pdf}
    \caption{A programmable widget is included that allows interactive simulation through sliders.}
    \label{Figure:carbon-ipython-widget}
  \end{subfigure}
  \caption{IPython Notebooks allow for in depth model simulation and analysis through a combined graphical and programmable interface.}
  \label{Figure:carbon-ipython}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=\textwidth,page=14,trim=0.37cm .65cm 0.37cm 0.3cm, clip=true]{images/Figures.pdf}
  \caption{Combine Archive files may be encoded into URLs which are received by Portal interface for running model files locally or on a server.}
  \label{Figure:carbon-combine-archive}
\end{figure}

